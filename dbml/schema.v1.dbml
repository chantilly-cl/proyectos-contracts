
Project proyectos_workflow {
  database_type: "PostgreSQL"
  Note: 'Dominio: Ventas → Proyectos (Cotización → Aprobaciones → NV → OT → DocVenta → Entrega/Instalación → Cierre). IDs UUID; timestamps en timestamptz; PriceList LOCK en Project; PriceAgreement snapshot (FREEZE).'
}

/* =========================
   ENUMS
   ========================= */
Enum ProjectState {
  Draft
  InApproval
  Approved
  SalesNoteIssued
  WorkInProgress
  Fulfillment
  Installation
  Closed
  Canceled
}

Enum ApprovalState {
  Pending
  Approved
  Rejected
}

Enum SalesNoteState {
  Emitida
  Anulada
}

Enum WorkOrderState {
  Pendiente
  EnProceso
  Terminado
  Cancelado
}

Enum SalesDocumentState {
  Emitido
  Anulado
}

Enum FulfillmentState {
  Planificada
  EnCurso
  Entregado
  Cancelada
}

Enum InstallationAppointmentState {
  Programada
  Realizada
  Aprobada
  Fallida
}

Enum AddressType {
  fiscal
  despacho
  instalacion
}

Enum StateType {
  commercial_1
  financial_1
}

Enum RoundingPolicy {
  PerLine
  PerDocument
}

/* =========================
   CLIENTE & PROYECTO
   ========================= */

Table address as Address {
  id uuid [pk, default: `gen_random_uuid()`]
  client_ref_id uuid [not null]
  type AddressType [not null, default: 'fiscal']
  street text [not null]
  number text
  commune text
  city text
  region text
  country text
  extra text
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]
}

Table project as Project {
  id uuid [pk, default: `gen_random_uuid()`]
  code text [not null] // Código humano: P-{yyyy}-{####}
  client_ref_id uuid [not null]
  ejecutivo_id uuid // Ejecutivo comercial
  installation_address_id uuid
  state ProjectState [not null, default: 'Draft']

  // LOCK de lista de precios asignada al proyecto
  price_list_ref_id uuid [not null]
  price_list_locked bool [not null, default: true]

  // NEW: Forma de pago asignada al proyecto (LOCK)
  payment_method_ref_id uuid // puede definirse luego en Draft
  payment_method_locked bool [not null, default: true]
  payment_terms_days int // opcional: 0=contado, 30/60/90 = crédito

  // Claves ERP (LOCK)
  client_external_id text [not null, note: "cwtauxi.CodAux"]
  price_list_key text [not null, note: "iwtlistpro.CodLista (LOCK)"]
  // NEW: key ERP de forma de pago (sombra para auditoría/envío rápido)
  payment_method_key text [note: "Softland.* código forma de pago (LOCK)"]
  payment_note string [note: "Nota sobre el pago"]

  quote_actual_id uuid // última cotización en edición
  quote_version_aprobada_id uuid // versión aprobada (si existe)

  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]
  Note: 'Se puede elegir cualquier lista de precios; al asignarse queda bloqueada (no se puede cambiar).'

  Indexes {
    (code) [unique]
    (client_ref_id, created_at)
  }
}

/* =========================
   CATÁLOGO / PRODUCT CONFIG
   ========================= */
Table option_set as OptionSet {
  id uuid [pk, default: `gen_random_uuid()`]
  product_ref_id uuid [not null, ref: > ProductRef.id]
  name text [not null]
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null]
}

Table option_definition as OptionDefinition {
  id uuid [pk, default: `gen_random_uuid()`]
  option_set_id uuid [not null, ref: > OptionSet.id]
  key string [not null] // ej: "ancho", "color"
  kind string [not null] // enum|number|bool|text
  required bool [not null, default: false]
  min numeric
  max numeric
  step numeric

  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null]
  Note: 'Las reglas numéricas y enums se persisten; el front puede consumir YAML sólo de UI.'
}

Table option_enum_value as OptionEnumValue {
  id uuid [pk, default: `gen_random_uuid()`]
  option_definition_id uuid [not null, ref: > OptionDefinition.id]
  value text [not null]
  label text [not null]
  sort_order int [not null, default: 0]

  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null]
}

Table custom_accionamientos as CustomAccionamiento {
  id uuid [pk, default: `gen_random_uuid()`]
  key string [not null]
  description string [not null]
  sku_motor string [not null]
  precio_motor double [not null]
  sku_control string [not null]
  precio_control double [not null]
  active bool [not null, default: true]

  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null]
}

Table custom_catalog_items as CustomCatalogItem {
  id uuid [pk, default: `gen_random_uuid()`]
  product_key string [not null]
  sku_roller string
  description string [not null]
  precio double [not null]
  tipo string
  categoria string
  active bool [not null, default: true]

  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null]
}

Table custom_componentes as CustomComponente {
  id uuid [pk, default: `gen_random_uuid()`]
  product_key string [not null]
  key string [not null]
  sku string [not null]
  description string [not null]
  precio double [not null]

  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null]
}

Table custom_enums as CustomEnum {
  id uuid [pk, default: `gen_random_uuid()`]
  group string [not null]
  key string [not null]
  description string [not null]
  factor double
  active bool [not null, default: true]

  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null]
}

/* =========================
   COTIZACIÓN (versionable)
   ========================= */
Table quote as Quote {
  id uuid [pk, default: `gen_random_uuid()`]
  project_id uuid [not null]
  title text
  validity_days int [not null, default: 30]
  currency text [not null, default: 'CLP']
  created_by text [not null]

  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null]
}

Table quote_version as QuoteVersion {
  id uuid [pk, default: `gen_random_uuid()`]
  quote_id uuid [not null]
  version_no int [not null, default: 1]

  // Cálculo (raw, con decimales)
  subtotal numeric(18,4) [not null, default: 0]
  discount numeric(18,4) [not null, default: 0]
  tax      numeric(18,4) [not null, default: 0]
  total    numeric(18,4) [not null, default: 0]
  erp_source_json jsonb
  notes text
  created_by uuid
  sent_at datetime2
  sent_by_user_id uuid
  global_discount_percent double [not null]
  global_discount_amount double [not null]

  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null]

  indexes { (quote_id, version_no) [unique] }
}

Table quote_item_version as QuoteItemVersion {
  id uuid [pk, default: `gen_random_uuid()`]
  quote_version_id uuid [not null]
  product_ref_id uuid
  feasibility_id uuid

  sku string
  description string

  // Cálculo (raw)
  quantity numeric(18,4) [not null, default: 1]
  unit_price numeric(18,4) [not null, default: 0]
  discount_percent numeric(18,4) [not null, default: 0]
  discount_amount numeric(18,4) [not null, default: 0]
  tax_rate numeric(7,4) [not null, default: 0] // admite 0.1900, etc.

  options_json jsonb
  kind string
  source string
  notes text

  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null]
}

Table quote_attachment as QuoteAttachment {
  id uuid [pk, default: `gen_random_uuid()`]
  quote_id uuid [not null]
  quote_version_id uuid
  filename text [not null]
  content_type text
  url text [not null] // S3/GCS
  uploaded_by text [not null]
  uploaded_at timestamptz [not null, default: `now()`]

  created_at timestamptz [not null, default: `now()`]
  created_by text [not null]
}

/* =========================
   PRICING & SNAPSHOTS
   ========================= */
Table price_agreement as PriceAgreement {
  id uuid [pk, default: `gen_random_uuid()`]
  project_id uuid [not null]
  quote_version_id uuid [not null]
  price_list_id uuid [not null]
  currency text [not null, default: 'CLP']
  snapshot_at timestamptz [not null, default: `now()`]
  totals_json jsonb

  created_at timestamptz [not null, default: `now()`]
  created_by text [not null]

  // NEW: Snapshot de forma de pago que aplicó al aprobar
  payment_method_key text
  payment_terms_days int
  Note: 'Snapshot de la versión aprobada de la cotización (FREEZE). Todos los docs posteriores consumen este snapshot.'

  Indexes { (project_id) [unique] }
}

/* =========================
   APROBACIONES & VISITA TÉCNICA
   ========================= */
Table technical_visit as TechnicalVisit {
  id uuid [pk, default: `gen_random_uuid()`]

  project_id uuid [not null]
  address_id uuid
  scheduled_at timestamptz
  visited_at timestamptz
  state ApprovalState [not null, default: 'Pending']
  notes text
  created_by text [not null]

  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]
}

Table commercial_approval as CommercialApproval {
  id uuid [pk, default: `gen_random_uuid()`]

  project_id uuid [not null]
  quote_id uuid [not null]
  step string [not null, default: 'commercial_1']
  state ApprovalState [not null, default: 'Pending']
  by_user_id uuid
  decided_by_user_id uuid
  decided_at timestamptz
  notes text

  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  Indexes { (project_id, quote_id, by_user_id, decided_by_user_id) [unique] }
}

Table financial_approval as FinancialApproval {
  id uuid [pk, default: `gen_random_uuid()`]

  project_id uuid [not null]
  quote_id uuid [not null]
  step string [not null, default: 'financial_1']
  state ApprovalState [not null, default: 'Pending']
  by_user_id uuid
  decided_by_user_id uuid
  decided_at timestamptz
  notes text

  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]
  Indexes {
    (project_id, quote_id, by_user_id, decided_by_user_id) [unique]
  }
}

/* =========================
   MANUFACTURA / ENTREGA
   ========================= */
Table sales_notes as SalesNote {
  id uuid [pk, default: `gen_random_uuid()`]
  project_id uuid [not null]
  state SalesNoteState [not null, default: 'Emitida']
  external_number text // NV del ERP si aplica
  issued_at timestamptz [not null, default: `now()`]
  created_by uuid [not null]

  // NEW: forma de pago efectiva usada al emitir la NV
  payment_method_key text
  payment_terms_days int

  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null]
}

Table work_orders as WorkOrder {
  id uuid [pk, default: `gen_random_uuid()`]

  project_id uuid [not null]
  code text [not null] // OT-{yyyy}-{####}
  state WorkOrderState [not null, default: 'Pendiente']
  started_at timestamptz
  finished_at timestamptz
  created_by text [not null]

  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null]

  Indexes { (code) [unique] }
}

Table work_order_items as WorkOrderItem {
  id uuid [pk, default: `gen_random_uuid()`]

  work_order_id uuid [not null]
  product_ref_id uuid [not null]
  description text
  quantity numeric(18,3) [not null, default: 1]
  unit text

  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null]
}

Table sales_documents as SalesDocument {
  id uuid [pk, default: `gen_random_uuid()`]
  project_id uuid [not null]
  state SalesDocumentState [not null, default: 'Emitido']
  doc_type text // Factura/Boleta
  doc_number text
  issued_at timestamptz
  total numeric(18,2)

  // NEW: forma de pago usada al emitir el documento
  payment_method_key text
  payment_terms_days int

  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null]
}

Table fulfillment_order as FulfillmentOrder {
  id uuid [pk, default: `gen_random_uuid()`]

  project_id uuid [not null]
  state FulfillmentState [not null, default: 'Planificada']
  scheduled_date date

  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null]
}

Table shipment as Shipment {
  id uuid [pk, default: `gen_random_uuid()`]

  fulfillment_order_id uuid [not null]
  carrier text
  tracking_code text
  dispatched_at timestamptz
  delivered_at timestamptz

  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null]
}

Table pickup as Pickup {
  id uuid [pk, default: `gen_random_uuid()`]
  fulfillment_order_id uuid [not null]
  pickup_at timestamptz
  picked_by text

  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null]
}

/* =========================
   INSTALACIÓN
   ========================= */
Table installation_order as InstallationOrder {
  id uuid [pk, default: `gen_random_uuid()`]

  project_id uuid [not null]
  address_id uuid
  requires_installation bool [not null, default: false]
  notes text

  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null]
}

Table installation_appointment as InstallationAppointment {
  id uuid [pk, default: `gen_random_uuid()`]

  installation_order_id uuid [not null]
  state InstallationAppointmentState [not null, default: 'Programada']
  starts_at timestamptz
  ends_at timestamptz
  approved_by_id uuid
  approved_at timestamptz
  notes text

  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null]
}

/* =========================
   WORKFLOW
   ========================= */
Table workflow_definitions as WorkflowDefinition {
  id uuid [pk, default: `gen_random_uuid()`]

  key text [not null, unique]
  name text [not null]

  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null]
}

Table workflow_stage_definitions as WorkflowStageDefinition {
  id uuid [pk, default: `gen_random_uuid()`]

  workflow_definition_id uuid [not null]
  key text [not null]
  name text [not null]
  sort_order int [not null, default: 0]

  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null]

  Indexes { (workflow_definition_id, key) [unique] }
}

Table workflow_transition_definitions as WorkflowTransitionDefinition {
  id uuid [pk, default: `gen_random_uuid()`]

  workflow_definition_id uuid [not null]
  from_stage_key text [not null]
  to_stage_key text [not null]
  guard_expression text // regla/gate declarativa

  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null]

  Indexes { (workflow_definition_id, from_stage_key, to_stage_key) [unique] }
}

Table workflow_instances as WorkflowInstance {
  id uuid [pk, default: `gen_random_uuid()`]

  project_id uuid [not null, unique]
  workflow_definition_id uuid [not null]
  current_stage_key text [not null]
  started_at timestamptz [not null, default: `now()`]

  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null]
}

Table workflow_events as WorkflowEvent {
  id uuid [pk, default: `gen_random_uuid()`]

  project_id uuid [not null]
  type text [not null] // Transition|Approval|System
  from_stage_key text
  to_stage_key text
  at timestamptz [not null, default: `now()`]
  by_user_id uuid
  payload_json jsonb

  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null]

  Indexes { (project_id, at) }
}

/* =========================
   TRANSVERSAL
   ========================= */
Table document_sequences as DocumentSequence {
  id uuid [pk, default: `gen_random_uuid()`]

  key string [not null, unique] // Q-, P-, NV-, OT-, DE-
  current bigint [not null, default: 0]

  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null]
  Note: 'Generación: {Key}{yyyy}-{####}. Mecanismo con fila bloqueada (SELECT FOR UPDATE) para concurrencia.'
}

Table idempotency_records as IdempotencyRecord {
  id uuid [pk, default: `gen_random_uuid()`]

  key string [not null, unique]
  method string [not null]
  path string [not null]
  fingerprint string [not null, unique]
  completed bool [not null]
  status_code int
  response_body string
  response_headers_json string
  expires_at datetime2 [not null, unique]
  current bigint [not null, default: 0]

  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null]
  Note: 'Generación: {Key}{yyyy}-{####}. Mecanismo con fila bloqueada (SELECT FOR UPDATE) para concurrencia.'
}

Table audit_logs as AuditLog {
  id uuid [pk, default: `gen_random_uuid()`]

  entity text [not null]
  entity_id uuid [not null]
  action text [not null] // Insert|Update|Delete|Override
  before_json jsonb
  after_json jsonb
  at timestamptz [not null, default: `now()`]
  user_id uuid

  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null]

  Indexes { (entity, entity_id, at) }
}

Table user_seller_links as UserSellerLink {
  id uuid [pk, default: `gen_random_uuid()`]

  external_user_id uuid [not null]
  email string
  seller_code string [not null] // Insert|Update|Delete|Override
  default_price_list string [not null, default: 'LA']
  default_roller_price_list string [not null, default: 'LMF']
  max_custom_product_discount double [not null, default: 10]
  active_product_discount bool [not null, default: true]
  valid_from datetime [not null]
  valid_to datetime
  created_at timestamptz [not null, default: `now()`]

  updated_at timestamptz [not null]
  created_by string [not null]

  Indexes { (external_user_id) }
}

/* ===========================
   READ-MODELS (desde ERP)
   =========================== */

Table client_refs as ClientRef {
  id uuid [pk, default: `gen_random_uuid()`]

  external_id text [not null, note: "Softland.cwtauxi.CodAux"]
  rut text
  name text
  email text
  phone text
  notes text
  synced_at timestamptz [not null, default: `now()`]

  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null]

  Note: "Copia no autoritativa; para autocomplete/joins"

  Indexes {
    (rut) [unique]
  }
}

Table price_list_refs as PriceListRef {
  id uuid [pk, default: `gen_random_uuid()`]

  key text [not null, note: "Softland.iwtlistpro.CodLista"]
  name text
  active bool [not null, default: true]
  source string [not null, default: 'ERP']
  currency string [not null, default: 'CLP']
  factor double [not null, default: 1]

  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null]
}

// NEW: catálogo de formas de pago desde ERP
Table payment_method_refs as PaymentMethodRef {
  id uuid [pk, default: `gen_random_uuid()`]

  key text [not null, note: "Softland.* código forma de pago"]
  name text [not null]
  requires_bank bool [not null, default: false]
  online bool [not null, default: false]
  clearing_days int [not null, default: 0]
  active bool [not null, default: true]
  synced_at timestamptz [not null, default: `now()`]

  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null]

  Indexes { (key) [unique] }
}

Table product_refs as ProductRef {
  id uuid [pk, default: `gen_random_uuid()`]

  sku string [not null, note: "Softland.iw_tprod.CodProd"]
  name string [not null]
  unit string
  active bool [not null, default: true]
  synced_at timestamptz [not null, default: `now()`]

  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null]

  Indexes { (sku) [unique] }
}

/* =========================
   RELATIONSHIPS (redundantes para claridad)
   ========================= */
Ref: Address.client_ref_id > ClientRef.id

Ref: Project.client_ref_id > ClientRef.id
Ref: Project.installation_address_id > Address.id
Ref: Project.price_list_ref_id > PriceListRef.id
Ref: Project.payment_method_ref_id > PaymentMethodRef.id // NEW
Ref: Project.quote_actual_id > Quote.id
Ref: Project.quote_version_aprobada_id > QuoteVersion.id

Ref: Quote.project_id > Project.id
Ref: QuoteVersion.quote_id > Quote.id
Ref: QuoteItemVersion.feasibility_id > Address.id
Ref: QuoteItemVersion.quote_version_id > QuoteVersion.id
Ref: QuoteItemVersion.product_ref_id > ProductRef.id

Ref: QuoteAttachment.quote_id > Quote.id
Ref: QuoteAttachment.quote_version_id > QuoteVersion.id

Ref: PriceAgreement.project_id > Project.id
Ref: PriceAgreement.quote_version_id > QuoteVersion.id
Ref: PriceAgreement.price_list_id > PriceListRef.id

Ref: TechnicalVisit.project_id > Project.id
Ref: TechnicalVisit.address_id > Address.id

Ref: CommercialApproval.project_id > Project.id
Ref: CommercialApproval.quote_id > Quote.id

Ref: FinancialApproval.project_id > Project.id
Ref: FinancialApproval.quote_id > Quote.id

Ref: SalesNote.project_id > Project.id
Ref: WorkOrder.project_id > Project.id
Ref: WorkOrderItem.work_order_id > WorkOrder.id
Ref: WorkOrderItem.product_ref_id > ProductRef.id

Ref: SalesDocument.project_id > Project.id

Ref: FulfillmentOrder.project_id > Project.id
Ref: Shipment.fulfillment_order_id > FulfillmentOrder.id
Ref: Pickup.fulfillment_order_id > FulfillmentOrder.id

Ref: InstallationOrder.project_id > Project.id
Ref: InstallationOrder.address_id > Address.id
Ref: InstallationAppointment.installation_order_id > InstallationOrder.id

Ref: WorkflowStageDefinition.workflow_definition_id > WorkflowDefinition.id
Ref: WorkflowTransitionDefinition.workflow_definition_id > WorkflowDefinition.id
Ref: WorkflowInstance.project_id > Project.id
Ref: WorkflowInstance.workflow_definition_id > WorkflowDefinition.id
Ref: WorkflowEvent.project_id > Project.id


/*
-- Schema update v1.1 (2025-10-06)
- Project: +ClientExternalId, +PriceListKey (LOCK)
- QuoteVersion: +PriceListKeyUsed, +SupersedesVersionId
- QuoteItemVersion: +ProductExternalId, +ProductSnapshotJson, +ErpSourceJson
- Read-models: ClientRef, ProductRef, PriceListRef
*/
